10/27

# Progate Path SQL インジェクション

## 入力はプレースホルダを使う。

```
`SELECT u.id, u.name, u.email, u.password, u.image_name, u.created_at, u.updated_at FROM users u WHERE u.email=? AND u.password=?`,
      email,
      password,
```

## password にはハッシュ値を使う

```
import bcrypt from "bcryptjs";
export class HashPassword {
  private readonly saltRounds: number;
  constructor() {
    this.saltRounds = 10;
  }
  async generate(plaintextPassword: string): Promise<string> {
    return bcrypt.hash(plaintextPassword, this.saltRounds);
  }
  async compare(plaintextPassword: string, hash: string): Promise<boolean> {
    return bcrypt.compare(plaintextPassword, hash);
  }
}
```

# Progate Path XSS を防ぐ

```
<%- post.content %>

```

=にすれば、サニタイズされる

```
 <%= post.content %>
```

## session の値を読み取られないようにする。express の設定を変更する

```
const loadSession = (app: Express): void => {
  app.use(
    session({
      name: "session",
      keys: ["some random secret key here"],
      // `secure` is set to true only when the app is running in production.
      //
      // If you are behind a reverse proxy, you must enable 'trust proxy' option
      // by `app.set('trust proxy', 1)`.
      // See https://expressjs.com/en/guide/behind-proxies.html for more details.
      secure: app.get("env") === "production",
      httpOnly: true, //ここをTrueへ
      sameSite: "lax",
      // This MUST be true, otherwise malicious users can set arbitrary cookies
      // and it can lead data breach.
      signed: true,
      maxAge: 1000 * 60 * 60 * 24 * 7, // 1 week in milliseconds
    }),
  );
};
```

## helmet を使用する

```
...
import expressLayouts from "express-ejs-layouts";
import helmet from "helmet";
...
export const loadMiddlewaresForTweetApp = (app: Express): void => {
  loadMethodOverride(app);
  loadSecureHeaders(app);
  ...
};
...
const loadSession = (app: Express): void => {
  app.use(
    session({
      ...
      secure: app.get("env") === "production",
      httpOnly: true,
      ...
    }),
  );
};
...
const loadSecureHeaders = (app: Express): void => {
  app.use(helmet());
  if (app.get("env") === "development" || app.get("env") === "test") {
    // Setting upgradeInsecureRequests to null in development/test environment
    // since safari redirects to https even on localhost and the page cannot be displayed.
    app.use(
      helmet.contentSecurityPolicy({
        useDefaults: true,
        directives: {
          upgradeInsecureRequests: null,
        },
      }),
    );
  }
};
```

# Progate Path 本人のみ編集できるようにする

src/middlewares/current_user.ts

```
...
export const ensureCorrectUser: RequestHandler = async (req, res, next) => {
  if (req.session === null || req.session === undefined) {
    next();
    return;
  }
  const {userId} = req.params;
  if (req.authentication?.currentUserId === Number(userId)) {
    next();
  } else {
    req.dialogMessage?.setMessage("Unauthorized access");
    res.redirect("/posts");
  }
};
...
```

src/routes/user.ts

```
...
import {ensureCorrectUser} from "@/middlewares/current_user";
...
userRouter.get(
  "/:userId/edit",
  ensureAuthUser,
  ensureCorrectUser,
  async (req, res) => {
    ...
  },
);

...
userRouter.patch(
  "/:userId",
  ensureAuthUser,
  ensureCorrectUser,
  uploadHandler,
  body("name", "Name can't be blank").notEmpty(),
  body("email", "Email can't be blank").notEmpty(),
  async (req, res, next) => {
    ...
  },
);
```
