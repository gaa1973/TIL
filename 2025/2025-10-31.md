# 今日やること

DB よりデータを取得しての認証 ←OK

Prisma でのデータ取得 ←OK

パスワード DB のハッシュ化 ←OK

JWT の実装 ← 実装途中

# Prisma

Prisma のデフォルト命名規則は、公式ドキュメントで定義されています。具体的には、以下のページで説明されています：

Prisma Schema の命名規則

@@map が指定されていない場合、Prisma はモデル名を基にテーブル名を自動生成します。（勝手に複数形から単数になどはしない）
この規則は Prisma の内部ロジックに基づき、camelCase から snake_case への変換と複数形化が行われます。
もしカスタマイズしたい場合は、@@map("custom_table_name")をモデルに追加してください。

#### 実行時エラー

まず、データ接続できない。Copilot からテーブル名の命名規則の嘘を教えられる。

検索する関数の作成が必要

Password 　ハッシュ化
bcrypt 　インストール
npm install bcrypt -s

Promise の使い方

```
new Promise((resolve, reject) => {
  // 非同期処理
  setTimeout(() => {
    resolve("成功"); // 成功時に結果を渡す
  }, 1000);
});
```

resolve は、Promise の成功状態を表す関数です。Promise 内で非同期処理が完了したときに呼び出し、結果を返す。

ハッシュ化関数

```
// src/utils/auth.ts
import bcrypt from 'bcrypt';

export const hashPassword = async (password: string): Promise<string> => {
  const saltRounds = 10;
  return await bcrypt.hash(password, saltRounds);
};

export const comparePassword = async (password: string, hash: string): Promise<boolean> => {
  return await bcrypt.compare(password, hash);
};
```

# JWT とは？

JSON Web Token(JWT)とは、相互にデータをやり取りする主体同士で安全に情報を JSON オブジェクトとして転送するためのコンパクトで自己記述的な方法です。この JSON オブジェクトの情報はデジタル署名されているため、検証および信頼できるものになっています。

JWT の流れ

1. ログイン
   ユーザーが ID / パスワードを使ってログインします。
   サーバーは認証に成功したら JWT を発行します：

header + payload を作成　 ← 　 reqest から email と password
header と payload を Base64 エンコードしてつなげる
秘密鍵で署名を生成する
JWT：header.payload.signature を完成させて返す

2. クライアントが JWT を保存
   クライアント（ブラウザやアプリ）は JWT を Cookie や LocalStorage に保存します。

3. API リクエストに JWT を添付
   その後のリクエストでは、HTTP ヘッダーに JWT をつけて送ります：

Authorization: Bearer <JWT>

4. サーバー側で検証
   サーバーはリクエストを受け取ると次の流れで検証します：

1. JWT を分解

header.payload.signature に分ける 2. header と payload を Base64 デコード

3. 署名を再計算

受け取った header と payload をつなげる
サーバーが持つ秘密鍵と header に書かれたアルゴリズムで署名を再生成する
フロントから送られてきた signature と突き合わせる → 一致すれば「改ざんナシ」と判断。 4. 有効性チェック
payload 内の exp が現在時刻より未来か確認（期限切れじゃないか）
問題なければ payload の sub（ユーザー ID）を取り出して処理を続ける
まとめ

JWT は header, payload, signature の 3 部構成
signature は「header+payload を秘密鍵でハッシュ化」して作る
サーバは秘密鍵を 一つ持って使い回す
フロントはログイン時にもらった JWT を Authorization ヘッダに載せて送る
サーバは毎回 署名を再計算して一致確認 → 改ざんされていないか保証できる

注意点
ペイロードは Base64 でエンコードされているだけなので、誰でも読める → 機密情報は入れない
exp（有効期限）を必ず設定すること
秘密鍵は絶対に漏洩させないこと
