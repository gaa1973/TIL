    const token =
      req.cookies?.token ||
      (req.header('Authorization') || '').replace(/^Bearer\s+/i, '') ||
      null;

## オプショナルチェイニングは

null / undefined のみをガードします。
空文字 '' や 0、false はガード対象ではなく、通常どおり評価されます。
a?.b || 'x' のように || と組み合わせると、a?.b が空文字でも || により右側にフォールバックされます。空文字を有効値にしたいなら ??（nullish 合体演算子）を使います：a?.b ?? ''（null/undefined の時だけデフォルト）。
TypeScript での互換性（コンパイル）

## src/middleware/auth.middleware.ts

現状：既に存在し、トークン検証して req.user = { id, email } をセットする実装がある。
サンプル差分：特に必須変更なし（ただし JWT ペイロードに userId を含めるなら payload.userId を優先して使うことを確認）。

## app.ts

現状：ログイン／登録／books ルートがある。cookie-parser 等は登録済み。login の jwt.sign は現在 payload = { email }。
サンプル差分（必要箇所のみ）：
login 成功時の jwt.sign(payload, ...) を payload = { userId: user.id, email } に変更（推奨、ミドルウェアの DB 参照を省く）。
import memosRouter from '@/routes/memos' を追加し、最後に app.use('/api/memos', memosRouter) を登録（ミドルウェアは router 側で適用するか、ここで authMiddleware を指定）。

## src/models/memos.ts (新規)

現状：存在しない（今回追加サンプルで新規）。DB は Prisma スキーマに Memo があるので、新ファイルを作って CRUD ラッパーを提供する必要あり。
サンプル差分：新規作成（createMemo/getMemosByAuthor/getMemoById/updateMemo/deleteMemo）。

## src/routes/memos.ts (新規)

現状：存在しない。
サンプル差分：新規作成。router.use(authMiddleware) で関所を設け、GET/POST/PATCH/DELETE を実装。更新・削除では existing.authorId === req.user.id をチェック。

## src/types/express.d.ts (新規・任意だが推奨)

現状：存在しない（型エラーが出る可能性あり）。
サンプル差分：Express.Request に user?: { id?: number; email?: string } を追加して TS の警告を防ぐ。

## schema.prisma / DB

現状：Memo モデルは既にある → DB マイグレーションは不要（既に同期されていれば）。
サンプル差分：なし（ただし DB にテーブルがなければマイグレーションを適用してください）。
フロント側・運用（設定）

現状：CORS と cookie-parser は設定済み。
サンプル差分：フロントは fetch(..., { credentials: 'include' }) で Cookie を送ること。login で userId を JWT に含める場合は特にフロント変更不要。
まとめ（一行）：実ファイル追加は models/routes の 2 つ、app.ts の login ペイロードとルータ登録を変更、型ファイルを置けば完了。私からはこれ以上ソースを変えません
